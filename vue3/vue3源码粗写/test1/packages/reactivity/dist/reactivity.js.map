{
  "version": 3,
  "sources": ["../src/effect.ts", "../src/reactiveEffect.ts", "../src/reactive.ts"],
  "sourcesContent": ["import type { KeyDepsMap } from './reactiveEffect';\r\n\r\nexport function effect(fn, options?) {\r\n  const _effect = new ActiveEffect(fn, () => {\r\n    _effect.run();\r\n  });\r\n  _effect.run();\r\n  if (options) {\r\n    Object.assign(_effect, options);\r\n  }\r\n  const effectRun = _effect.run.bind(_effect);\r\n  return effectRun;\r\n};\r\n\r\n// \u5F53\u524D\u6267\u884C\u7684\u526F\u4F5C\u7528\u51FD\u6570\u7684\u5305\u88C5\u51FD\u6570\r\nexport let activeEffect: ActiveEffectClass | undefined = undefined;\r\n\r\nconst activeEffectsStack: ActiveEffectClass[] = [];\r\nexport abstract class ActiveEffectClass {\r\n  abstract _trackId: number;\r\n  abstract depsKeyDepsMap: any[];\r\n  abstract _depsKeyDepsMapLength: number;\r\n\r\n  // abstract fn: () => void;\r\n  constructor(public fn: () => void, public scheduler?: () => void) { };\r\n  abstract run: () => void;\r\n};\r\n\r\n\r\n\r\nclass ActiveEffect implements ActiveEffectClass {\r\n  _trackId = 0; // \u7528\u4E8E\u8BB0\u5F55\u5F53\u524D\u7684\u526F\u4F5C\u7528\u51FD\u6570\u6267\u884C\u4E86\u51E0\u6B21\r\n  depsKeyDepsMap = []; // \u7528\u4E8E\u6536\u96C6\u5F53\u524D\u7684\u8FD9\u4E2A\u88AB\u5305\u88C5\u7684\u526F\u4F5C\u7528\u51FD\u6570\u88AB\u54EA\u4E9B key \u6536\u96C6\u4E86\uFF0C\u7531\u4E8E\u4E3B\u8981\u662F\u4E3A\u4E86\u62FF\u5230 key \u5BF9\u5E94\u7684 keyDepsMap\uFF0C\u6240\u4EE5\u76F4\u63A5\u5B58\u7684\u5C31\u662F keyDepsMap\r\n  _depsKeyDepsMapLength = 0;\r\n\r\n  constructor(public fn, public scheduler?) { }\r\n  run() {\r\n    // try {\r\n    activeEffect = this;\r\n    activeEffectsStack.push(activeEffect);\r\n    this.fn();\r\n    // } finally {\r\n    activeEffectsStack.pop();\r\n    activeEffect = activeEffectsStack[activeEffectsStack.length - 1];\r\n    // }\r\n  };\r\n};\r\n// \u6536\u96C6\u5305\u88C5\u7684\u526F\u4F5C\u7528\u51FD\u6570\uFF0C\u5E76\u4E14\u8BB0\u5F55\u5F53\u524D\u7684\u526F\u4F5C\u7528\u51FD\u6570\u88AB\u54EA\u4E9B key \u6536\u96C6\u4E86\r\nexport function trackEffect(activeEffect: ActiveEffectClass, keyDesMap: KeyDepsMap) {\r\n  debugger\r\n  // \u5C06\u5F53\u524D\u7684\u88AB\u5305\u88C5\u7684\u526F\u4F5C\u7528\u884C\u6570\uFF0C\u52A0\u5165\u5230\u5F53\u524D\u7684 key \u7684\u4F9D\u8D56 map \u4E2D\r\n  keyDesMap.set(activeEffect, activeEffect._trackId);\r\n  // \u60F3\u8981\u77E5\u9053\u5F53\u524D\u7684 activeEffect \u88AB\u54EA\u4E9B keyDesMap \u6536\u96C6\u4E86\r\n  activeEffect.depsKeyDepsMap[activeEffect._depsKeyDepsMapLength++] = keyDesMap;\r\n}\r\n\r\nexport function triggerEffects(keyDepsMap: KeyDepsMap) {\r\n  // \u89E6\u53D1 key \u5BF9\u5E94\u7684 map \u4E2D\u7684\u6240\u6709\u5305\u88C5\u8FC7\u7684\u526F\u4F5C\u7528\u51FD\u6570\r\n  for (let effect of keyDepsMap.keys()) {\r\n    if (effect.scheduler) {\r\n      effect.scheduler();\r\n    }\r\n  }\r\n}", "import { activeEffect, trackEffect, triggerEffects } from './effect';\r\n\r\nimport type { ActiveEffectClass as ActiveEffectClassType } from './effect';\r\n\r\nexport type KeyDepsMap = Map<ActiveEffectClassType, ActiveEffectClassType['_trackId']> & {\r\n  cleanup?: () => void,\r\n  name?: string,\r\n}\r\nexport type ObjectDepsMap = Map<string, KeyDepsMap>\r\nexport type TargetMap = WeakMap<object, ObjectDepsMap>\r\n\r\nconst targetMap: TargetMap = new WeakMap(); // \u7528\u4E8E\u5B58\u653E\u6574\u4E2A\u5BF9\u8C61\u7684\u4F9D\u8D56\u6536\u96C6\r\n\r\n// \u8BFB\u7684\u65F6\u5019\uFF0C\u6536\u96C6\u5F53\u524D\u526F\u4F5C\u7528\u51FD\u6570\u7684\u5305\u88C5\u51FD\u6570\r\nexport function track(target, key) {\r\n  if (!activeEffect) {\r\n    return;\r\n  }\r\n  let objectDepsMap = targetMap.get(target);\r\n  if (!objectDepsMap) {\r\n    objectDepsMap = new Map();\r\n    targetMap.set(target, objectDepsMap);\r\n  }\r\n  let keyDepsMap = objectDepsMap.get(key);\r\n  if (!keyDepsMap) {\r\n    keyDepsMap = new Map();\r\n    // \u63D0\u4F9B\u6E05\u7406\u51FD\u6570\uFF0C\u597D\u5728\u4EE5\u540E\u76F4\u63A5\u5C06\u6574\u4E2A key \u5BF9\u76F8\u5E94\u7684 map \u5728 objectDepsMap \u5220\u9664\u6389\r\n    keyDepsMap.cleanup = () => objectDepsMap.delete(key);\r\n    keyDepsMap.name = key;\r\n    objectDepsMap.set(key, keyDepsMap);\r\n  }\r\n  trackEffect(activeEffect, keyDepsMap);\r\n};\r\n\r\n// \u5199\u7684\u65F6\u5019\uFF0C\u6267\u884C\u5F53\u524D key \u6536\u96C6\u7684\u526F\u4F5C\u7528\u51FD\u6570\r\nexport function trigger(target, key, oldValue, value) {\r\n  if (!targetMap) {\r\n    return;\r\n  }\r\n  const objectDepsMap = targetMap.get(target);\r\n  if (!objectDepsMap) {\r\n    return;\r\n  }\r\n  const keyDepsMap = objectDepsMap.get(key);\r\n  if (!keyDepsMap) {\r\n    return;\r\n  }\r\n  triggerEffects(keyDepsMap);\r\n}", "import { track, trigger } from './reactiveEffect';\r\n\r\nconst targetMap = new WeakMap();\r\n\r\nexport function reactive(obj) {\r\n  if (typeof obj !== 'object') {\r\n    return obj;\r\n  }\r\n  if (targetMap.get(obj)) {\r\n    return targetMap.get(obj);\r\n  }\r\n  const proxy = new Proxy(obj, mutableHandlers);\r\n  targetMap.set(obj, proxy);\r\n  return proxy;\r\n};\r\n\r\nconst mutableHandlers: ProxyHandler<object> = {\r\n  get(target, key, receiver) {\r\n    // \u6536\u96C6\u88AB\u5305\u88C5\u8FC7\u7684\u5F53\u524D effect \u5185\u5BB9\r\n    track(target, key);\r\n    return Reflect.get(target, key, receiver);\r\n\r\n  },\r\n  set(target, key, value, receiver) {\r\n    let oldValue = target[key];\r\n    // \u6CE8\u610F\u8FD9\u91CC\u8981\u5148\u8C03\u7528\u5728\u89E6\u53D1\u526F\u4F5C\u7528\u51FD\u6570\u7684\u6267\u884C\uFF0C\u4E0D\u7136\uFF0C\u6267\u884C\u526F\u4F5C\u7528\u51FD\u6570\u65F6\uFF0C\u83B7\u53D6\u5230\u7684\u6570\u636E\u662F\u65E7\u7684\u6570\u636E\r\n    const data = Reflect.set(target, key, value, receiver);\r\n    if (oldValue !== value) { // \u65B0\u65E7\u4E0D\u4E00\u81F4\u7684\u65F6\u5019\uFF0C\u624D\u8FDB\u884C\u526F\u4F5C\u7528\u51FD\u6570\u7684\u6267\u884C\r\n      trigger(target, key, oldValue, value);\r\n    }\r\n    return data;\r\n  },\r\n}\r\n"],
  "mappings": "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",
  "names": ["activeEffect", "effect", "targetMap"]
}
